#!/usr/bin/perl -w

my $rcsid = ''; $rcsid .= '$Id: stats-redo-fymp,v 1.3 2007-08-02 11:45:00 matthew Exp $';

use strict;
require 5.8.0;

# Horrible boilerplate to set up appropriate library paths.
use FindBin;
use lib "$FindBin::Bin/../perllib";
use lib "$FindBin::Bin/../../perllib";

use utf8;
binmode(STDOUT, ':utf8');

use mySociety::Sundries;

# XXX: Yes, this isn't proper or anything, but I just wanted it done.
my %reps_by_name;
open (FP, '../table');
while (<FP>) {
    chomp;
    my ($name, $repid, $person_id) = split /\s+\|\s+/;
    $name = lc($name);
    $reps_by_name{$name} = $person_id;
}
close FP;

open (FP, '../web/fymp.html');
$_ = join('', <FP>);
close FP;

print '<?php
/* Automatically generated by fyr/bin/stats-redo-fymp */

$questionnaire_report_FYMP_WMC = array(
';

my $c = 0;
while (/<tr>(.*?)<\/tr>/sg) {
    my $row = $1;
    my ($name, $cons, $party, $total, $yes, $no, $percent, $notes) = $row =~ /<td>(.*?)<\/td>/g;
    $name =~ s/'/\\'/g;
    $cons =~ s/'/\\'/g;
    $party =~ s/<\/?font.*?>//g;
    my $responded_outof = $yes+$no;
    my ($re_mean, $re_low, $re_high) = $responded_outof>0 ? mySociety::Sundries::binomial_confidence_interval($yes, $responded_outof) : ('', '', '');
    my $time = time();
    my $category = 'good';
    $category = 'toofew' if ($notes eq 'No data');
    $category = 'shame' if ($notes eq 'Does not accept messages');
    $category = 'badcontact' if ($notes eq 'No contact details');
    $c++;

    my $lookup_name = lc($name);
    $lookup_name =~ s/^(dr|sir|mrs|hon|lady) //;
    $lookup_name =~ s/ (qc|jp|fsa|bem|bart\.|obe|cbe|mbe)$//g;
    $lookup_name =~ s/ (qc|jp|fsa|bem|bart\.|obe|cbe|mbe)$//g;
    $lookup_name =~ s/\\'/'/;
    my $person_id = $reps_by_name{$lookup_name};
    #print STDERR "$lookup_name $name $cons\n" if (!$person_id);
    $person_id = "ERROR" if (!$person_id);
    $person_id =~ s/10593/10594/ if ($name eq 'Gareth Thomas' && $cons eq 'Harrow West');
    $person_id =~ s/11814/10546/ if ($name eq 'Angela Smith' && $cons eq 'Basildon');

    print "    array(
        'person_id' => '$person_id',
        'category' => '$category',
        'name' => '$name',
        'party' => '$party',
        'area' => '$cons',
        'dispatched_success' => '$total',
        'responded' => '$yes',
        'responded_outof' => '$responded_outof',
        'responded_mean' => '$re_mean',
        'responded_95_low' => '$re_low',
        'responded_95_high' => '$re_high',
        'when_generated' => '$time'
    ),\n";
}
print ");\n";
